/***
|''Name:''|YourSearchPlugin|
|''Version:''|2.0.0 (2006-01-16)|
|''Source:''|http://tiddlywiki.abego-software.de/#YourSearchPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license]]|
|''TiddlyWiki:''|2.0|
|''Browser:''|Firefox 1.0.4+; InternetExplorer 6.0|
<<tiddler [[YourSearch Introduction]]>>
For more information see [[Help|YourSearch Help]].

!Compatibility
This plugin requires TiddlyWiki 2.0. 
Use http://tiddlywiki.abego-software.de/#YourSearchPlugin-1.0.1 for older TiddlyWiki versions.

!Revision history
* v2.0.0 (2006-01-16)
** Add User Interface
* v1.0.1 (2006-01-06)
** Support TiddlyWiki 2.0
* v1.0.0 (2005-12-28)
** initial version
/%
***/
// The following code is "compressed". To get a readable version look at http://tiddlywiki.abego-software.de/#YourSearchPlugin-src
if(!version.extensions.YourSearchPlugin){version.extensions.YourSearchPlugin={major:2,minor:0,revision:0,date:new Date(2006,1,16),type:"plugin",source:"http://tiddlywiki.abego-software.de/#YourSearchPlugin"};var alertAndThrow=function(_1){alert(_1);throw _1;};if(!window.abego){window.abego={};}if(abego.YourSearch){alertAndThrow("abego.YourSearch already defined");}abego.YourSearch={};if(version.major<2){alertAndThrow("YourSearchPlugin requires TiddlyWiki 2.0 or newer.\n\nGet YourSearch 1.0.1 to use YourSearch with older versions of TiddlyWiki.\n\nhttp://tiddlywiki.abego-software.de/#YourSearchPlugin-1.0.1");}var STQ=function(_2,_3,_4,_5){this.queryText=_2;this.caseSensitive=_3;if(_5){this.regExp=new RegExp(_2,_3?"mg":"img");return;}this.terms=[];var re=/\s*(\-)?([#%!]*)(?:(?:("(?:(?:\\")|[^"])*")|(\S+)))(?:\s+((?:[aA][nN][dD])|(?:[oO][rR]))(?!\S))?/mg;var _7=re.exec(_2);while(_7!=null&&_7.length==6){var _8="-"==_7[1];var _9=_7[2].length==0||_7[2].indexOf("!")>=0;var _a=!_4&&(_7[2].length==0||_7[2].indexOf("%")>=0);var _b=!_4&&(_7[2].length==0||_7[2].indexOf("#")>=0);var _c;if(_7[3]){try{_c=eval(_7[3]);}catch(ex){}}else{_c=_7[4];}if(!_c){throw "Invalid search expression: %0".format([_2]);}var _d=_7[5]&&_7[5].charAt(0).toLowerCase()=="o";this.terms.push(new STQ.Term(_c,_9,_a,_b,_8,_d,_3));_7=re.exec(_2);}};var me=STQ.prototype;me.getMatchingTiddlers=function(_e){var _f=[];for(var i in _e){var t=_e[i];if((t instanceof Tiddler)&&this.matchesTiddler(t)){_f.push(t);}}return _f;};me.matchesTiddler=function(_12){if(this.regExp){return this.regExp.test(_12.title)||this.regExp.test(_12.text);}var n=this.terms.length;if(n==0){return false;}var _14=this.terms[0].matchesTiddler(_12);for(var i=1;i<this.terms.length;i++){if(this.terms[i-1].orFollows){if(!_14){_14|=this.terms[i].matchesTiddler(_12);}}else{if(_14){_14&=this.terms[i].matchesTiddler(_12);}}}return _14;};me.getOnlyMatchTitleQuery=function(){if(!this.onlyMatchTitleQuery){this.onlyMatchTitleQuery=new STQ(this.queryText,this.caseSensitive,true,this.useRegExp);}return this.onlyMatchTitleQuery;};me.getMarkRegExp=function(){if(this.regExp){return "".search(this.regExp)>=0?null:this.regExp;}var _16={};var n=this.terms.length;for(var i=0;i<this.terms.length;i++){var _19=this.terms[i];if(!_19.negate){_16[_19.text]=true;}}var _1a=[];for(var t in _16){_1a.push("("+t.escapeRegExp()+")");}if(_1a.length==0){return null;}var _1c=_1a.join("|");markRE=new RegExp(_1c,this.caseSensitive?"mg":"img");return markRE;};me.toString=function(){if(this.regExp){return this.regExp.toString();}var _1d="";for(var i=0;i<this.terms.length;i++){_1d+=this.terms[i].toString();}return _1d;};STQ.Term=function(_1f,_20,_21,_22,_23,_24,_25){this.text=_1f;this.inTitle=_20;this.inText=_21;this.inTag=_22;this.negate=_23;this.orFollows=_24;this.caseSensitive=_25;this.regExp=new RegExp(_1f.escapeRegExp(),"m"+(_25?"":"i"));};STQ.Term.prototype.toString=function(){return (this.negate?"-":"")+(this.inTitle?"!":"")+(this.inText?"%":"")+(this.inTag?"#":"")+"\""+this.text+"\""+(this.orFollows?" OR ":" AND ");};STQ.Term.prototype.matchesTiddler=function(_26){if(!_26){return false;}if(this.inTitle&&this.regExp.test(_26.title)){return !this.negate;}if(this.inText&&this.regExp.test(_26.text)){return !this.negate;}if(this.inTag){var _27=_26.tags;if(_27){for(var i=0;i<_27.length;i++){if(this.regExp.test(_27[i])){return !this.negate;}}}}return this.negate;};var stringToInt=function(s,_2a){if(!s){return _2a;}var n=parseInt(s);return (n==NaN)?_2a:n;};var getIntAttribute=function(_2c,_2d,_2e){return stringToInt(_2c.getAttribute(_2d));};var isDescendantOrSelf=function(_2f,e){while(e!=null){if(_2f==e){return true;}e=e.parentNode;}return false;};var getMatchCount=function(s,re){var m=s.match(re);return m?m.length:0;};var createEllipsis=function(_34){var e=createTiddlyElement(_34,"span");e.innerHTML="&hellip;";};var isWordChar=function(c){return (c>="a"&&c<="z")||(c>="A"&&c<="Z")||c=="_";};var getWordBounds=function(s,_38){if(!isWordChar(s[_38])){return null;}for(var i=_38-1;i>=0&&isWordChar(s[i]);i--){}var _3a=i+1;var n=s.length;for(i=_38+1;i<n&&isWordChar(s[i]);i++){}return {start:_3a,end:i};};var removeTextDecoration=function(s){var _3d=["''","{{{","}}}","//","<<<","/***","***/"];var _3e="";for(var i=0;i<_3d.length;i++){if(i!=0){_3e+="|";}_3e+="("+_3d[i].escapeRegExp()+")";}return s.replace(new RegExp(_3e,"mg"),"").trim();};var logText="";var lastLogTime=null;var logMessage=function(_40,s){var now=new Date();var _43=lastLogTime?(now-lastLogTime).toString():"";logText+="<tr><td>"+now.convertToYYYYMMDDHHMMSSMMM()+"</td><td align='right'>"+_43+"</td><td>"+_40+"</td><td>"+s.htmlEncode()+"</td></tr>\n";lastLogTime=now;};function writeLog(){var t=" <<JsDoIt 'WriteLog' 'WriteLog' 'javascript:writeLog();story.closeTiddler(\"Log\");story.displayTiddler(null,\"Log\");'>>"+"<html><table><tbody><tr><th>Time</th><th>Delta (ms)</th><th>Kind</th><th>Message</th></tr>\n"+logText+"</tbody></table></html>";store.saveTiddler("Log","Log",t,config.options.txtUserName,new Date(),["System","Log"]);logText="";lastLogTime=null;}var yourSearchResultID="yourSearchResult";var yourSearchResultItemsID="yourSearchResultItems";var maxCharsInTitle=80;var maxCharsInTags=50;var maxCharsInText=250;var maxPagesInNaviBar=10;var itemsPerPageDefault=25;var itemsPerPageWithPreviewDefault=10;var minMatchWithContextSize=40;var maxMovementForWordCorrection=4;var matchInTitleWeight=4;var precisionInTitleWeight=10;var matchInTagsWeight=2;var resultElement;var lastResults;var lastQuery;var lastSearchText;var searchInputField;var searchButton;var firstIndexOnPage=0;var currentTiddler;var indexInPage;var indexInResult;var getItemsPerPage=function(){var n=(config.options.chkPreviewText)?stringToInt(config.options.txtItemsPerPageWithPreview,itemsPerPageWithPreviewDefault):stringToInt(config.options.txtItemsPerPage,itemsPerPageDefault);return (n>0)?n:1;};var standardRankFunction=function(_46,_47){var _48=_47.getMarkRegExp();if(!_48){return 1;}var _49=_46.title.match(_48);var _4a=_49?_49.length:0;var _4b=getMatchCount(_46.getTags(),_48);var _4c=_49?_49.join("").length:0;var _4d=_46.title.length>0?_4c/_46.title.length:0;var _4e=_4a*matchInTitleWeight+_4b*matchInTagsWeight+_4d*precisionInTitleWeight+1;return _4e;};var findMatches=function(_4f,_50,_51,_52,_53,_54){lastSearchText=_50;var _55=_4f.reverseLookup("tags",_54,false);var _56=new STQ(_50,_51,false,_52);lastQuery=_56;var _57=_56.getMatchingTiddlers(_55);var _58=abego.YourSearch.getRankFunction();for(var i=0;i<_57.length;i++){var _5a=_57[i];var _5b=_58(_5a,_56);_5a.searchRank=_5b;}if(!_53){_53="title";}var _5c=function(a,b){var _5f=a.searchRank-b.searchRank;if(_5f==0){if(a[_53]==b[_53]){return (0);}else{return (a[_53]<b[_53])?-1:+1;}}else{return (_5f>0)?-1:+1;}};_57.sort(_5c);for(var i=0;i<_57.length;i++){delete _57[i].searchRank;}lastResults=_57;return _57;};var moveToWordBorder=function(s,_62,_63){var _64;if(_63){_64=getWordBounds(s,_62);}else{if(_62<=0){return _62;}_64=getWordBounds(s,_62-1);}if(!_64){return _62;}if(_63){if(_64.start>=_62-maxMovementForWordCorrection){return _64.start;}if(_64.end<=_62+maxMovementForWordCorrection){return _64.end;}}else{if(_64.end<=_62+maxMovementForWordCorrection){return _64.end;}if(_64.start>=_62-maxMovementForWordCorrection){return _64.start;}}return _62;};var getContextRangeAround=function(s,_66,_67,_68,_69){var _6a=Math.max(Math.floor(_69/(_68+1)),minMatchWithContextSize);var _6b=Math.max(_6a-(_67-_66),0);var _6c=Math.min(Math.floor(_67+_6b/3),s.length);var _6d=Math.max(_6c-_6a,0);_6d=moveToWordBorder(s,_6d,true);_6c=moveToWordBorder(s,_6c,false);return {start:_6d,end:_6c};};var getTextAndMatchArray=function(s,_6f){var _70=[];if(_6f){var _71=0;var n=s.length;var _73=0;do{_6f.lastIndex=_71;var _74=_6f.exec(s);if(_74){if(_71<_74.index){var t=s.substring(_71,_74.index);_70.push({text:t});}_70.push({text:_74[0],isMatch:true});_71=_74.index+_74[0].length;}else{_70.push({text:s.substr(_71)});break;}}while(true);}else{_70.push({text:s});}return _70;};var simpleCreateLimitedTextWithMarks=function(_76,s,_78){if(!lastQuery){return;}var _79=getTextAndMatchArray(s,lastQuery.getMarkRegExp());var _7a=0;for(var i=0;i<_79.length&&_7a<_78;i++){var t=_79[i];var _7d=t.text;if(t.isMatch){createTiddlyElement(_76,"span",null,"marked",_7d);}else{var _7e=_78-_7a;if(_7e<_7d.length){_7d=_7d.substring(0,_7e)+"...";}createTiddlyText(_76,_7d);}_7a+=_7d.length;}};var addRange=function(_7f,_80,_81){var n=_7f.length;if(n==0){_7f.push({start:_80,end:_81});return;}var i=0;for(;i<n;i++){var _84=_7f[i];if(_84.start<=_81&&_80<=_84.end){var _85=i+1;for(;_85<n;_85++){var r=_7f[_85];if(r.start>_81||_80>_84.end){break;}}var _87=_80;var _88=_81;for(var j=i;j<_85;j++){var r=_7f[j];_87=Math.min(_87,r.start);_88=Math.max(_88,r.end);}_7f.splice(i,_85-i,{start:_87,end:_88});return;}if(_84.start>_81){break;}}_7f.splice(i,0,{start:_80,end:_81});};var getTotalRangesSize=function(_8b){var _8c=0;for(var i=0;i<_8b.length;i++){var _8e=_8b[i];_8c+=_8e.end-_8e.start;}return _8c;};var writeTextAndMatchRange=function(_8f,s,_91,_92,_93){var pos=0;var i=0;var _96=0;for(;i<_91.length;i++){var t=_91[i];var _98=t.text;if(_92<pos+_98.length){_96=_92-pos;break;}pos+=_98.length;}var _99=_93-_92;for(;i<_91.length&&_99>0;i++){var t=_91[i];var _9b=t.text.substr(_96);_96=0;if(_9b.length>_99){_9b=_9b.substr(0,_99);}if(t.isMatch){createTiddlyElement(_8f,"span",null,"marked",_9b);}else{createTiddlyText(_8f,_9b);}_99-=_9b.length;}if(_93<s.length){createEllipsis(_8f);}};var getMatchedTextCount=function(_9c){var _9d=0;for(var i=0;i<_9c.length;i++){if(_9c[i].isMatch){_9d++;}}return _9d;};var getMatchedTextWithContextRanges=function(_9f,s,_a1){var _a2=[];var _a3=getMatchedTextCount(_9f);var pos=0;for(var i=0;i<_9f.length;i++){var t=_9f[i];var _a7=t.text;if(t.isMatch){var _a8=getContextRangeAround(s,pos,pos+_a7.length,_a3,_a1);addRange(_a2,_a8.start,_a8.end);}pos+=_a7.length;}return _a2;};var fillUpRanges=function(s,_aa,_ab){var _ac=_ab-getTotalRangesSize(_aa);while(_ac>0){if(_aa.length==0){addRange(_aa,0,moveToWordBorder(s,_ab,false));return;}else{var _ad=_aa[0];var _ae;var _af;if(_ad.start==0){_ae=_ad.end;if(_aa.length>1){_af=_aa[1].start;}else{addRange(_aa,_ae,moveToWordBorder(s,_ae+_ac,false));return;}}else{_ae=0;_af=_ad.start;}var _b0=Math.min(_af,_ae+_ac);addRange(_aa,_ae,_b0);_ac-=(_b0-_ae);}}};var writeRanges=function(_b1,s,_b3,_b4,_b5){if(_b4.length==0){return;}if(_b4[0].start>0){createEllipsis(_b1);}var _b6=_b5;for(var i=0;i<_b4.length&&_b6>0;i++){var _b8=_b4[i];var len=Math.min(_b8.end-_b8.start,_b6);writeTextAndMatchRange(_b1,s,_b3,_b8.start,_b8.start+len);_b6-=len;}};var createLimitedTextWithMarksAndContext=function(_ba,s,_bc){if(!lastQuery){return;}if(s.length<_bc){_bc=s.length;}var _bd=getTextAndMatchArray(s,lastQuery.getMarkRegExp());var _be=getMatchedTextWithContextRanges(_bd,s,_bc);fillUpRanges(s,_be,_bc);writeRanges(_ba,s,_bd,_be,_bc);};var createLimitedTextWithMarks=function(_bf,s,_c1){return createLimitedTextWithMarksAndContext(_bf,s,_c1);};var myStorySearch=function(_c2,_c3,_c4){highlightHack=new RegExp(_c4?_c2.escapeRegExp():_c2,_c3?"mg":"img");var _c5=findMatches(store,_c2,_c3,_c4,"title","excludeSearch");firstIndexOnPage=0;showResult();highlightHack=null;};var myMacroSearchHandler=function(_c6,_c7,_c8){var _c9="";var _ca=null;var _cb=function(txt){if(txt.value.length>2){if(config.options.chkUseYourSearch){myStorySearch(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}else{story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}_c9=txt.value;}};var _cd=function(e){_cb(searchInputField);return false;};var _cf=function(e){if(!e){var e=window.event;}switch(e.keyCode){case 13:_cb(this);break;case 27:if(isResultOpen()){closeResult();}else{this.value="";clearMessage();}break;}if(String.fromCharCode(e.keyCode)==this.accessKey||e.altKey){reopenResultIfApplicable();}if((this.value.length>2)&&(this.value!=_c9)){if(!config.options.chkUseYourSearch||config.options.chkSearchAsYouType){if(_ca){clearTimeout(_ca);}var txt=this;_ca=setTimeout(function(){_cb(txt);},500);}}if(this.value.length==0){closeResult();}};var _d3=function(e){this.select();reopenResultIfApplicable();};var btn=createTiddlyButton(_c6,this.label,this.prompt,_cd);var txt=createTiddlyElement(_c6,"input",null,null,null);if(_c8[0]){txt.value=_c8[0];}txt.onkeyup=_cf;txt.onfocus=_d3;txt.setAttribute("size",this.sizeTextbox);txt.setAttribute("accessKey",this.accessKey);txt.setAttribute("autocomplete","off");if(config.browser.isSafari){txt.setAttribute("type","search");txt.setAttribute("results","5");}else{txt.setAttribute("type","text");}searchInputField=txt;searchButton=btn;};var isResultOpen=function(){return resultElement!=null&&resultElement.parentNode==document.body;};var closeResult=function(){if(isResultOpen()){document.body.removeChild(resultElement);}};var openAllFoundTiddlers=function(){closeResult();if(lastResults){for(var i=lastResults.length-1;i>=0;i--){story.displayTiddler(null,lastResults[i].title);}}};var refreshResult=function(){if(!resultElement||!searchInputField){return;}var _d8=store.getTiddlerText("YourSearchResultTemplate");if(!_d8){_d8="<b>Tiddler YourSearchResultTemplate not found</b>";}resultElement.innerHTML=_d8;firstIndexOnPage=Math.floor(firstIndexOnPage/getItemsPerPage())*getItemsPerPage();applyHtmlMacros(resultElement,null);refreshElements(resultElement,null);if(lastResults&&lastResults.length>0){var _d9=store.getTiddlerText("YourSearchItemTemplate");if(!_d9){alertAndThrow("YourSearchItemTemplate not found");}var _da=document.getElementById(yourSearchResultItemsID);if(!_da){_da=createTiddlyElement(resultElement,"div",yourSearchResultItemsID);}var _db=Math.min(firstIndexOnPage+getItemsPerPage(),lastResults.length);indexInPage=-1;for(var i=firstIndexOnPage;i<_db;i++){currentTiddler=lastResults[i];indexInPage++;indexInResult=i;var _dd=createTiddlyElement(_da,"div",null,"yourSearchItem");_dd.innerHTML=_d9;applyHtmlMacros(_dd,null);refreshElements(_dd,null);}}currentTiddler=null;ensureResultIsDisplayedNicely();};var ensureResultIsDisplayedNicely=function(){adjustResultPositionAndSize();scrollVisible();};var scrollVisible=function(){if(resultElement){window.scrollTo(0,ensureVisible(resultElement));}if(searchInputField){window.scrollTo(0,ensureVisible(searchInputField));}};var adjustResultPositionAndSize=function(){if(!searchInputField){return;}var _de=searchInputField;var _df=findPosX(_de);var _e0=findPosY(_de);var _e1=_de.offsetHeight;var _e2=_df;var _e3=_e0+_e1;var _e4=findWindowWidth();if(_e4<resultElement.offsetWidth){resultElement.style.width=(_e4-100)+"px";_e4=findWindowWidth();}var _e5=resultElement.offsetWidth;if(_e2+_e5>_e4){_e2=_e4-_e5-30;}if(_e2<0){_e2=0;}resultElement.style.left=_e2+"px";resultElement.style.top=_e3+"px";resultElement.style.display="block";};var showResult=function(){if(!resultElement){resultElement=createTiddlyElement(document.body,"div",yourSearchResultID,"yourSearchResult");}else{if(resultElement.parentNode!=document.body){document.body.appendChild(resultElement);}}refreshResult();};var reopenResultIfApplicable=function(){if(searchInputField==null||!config.options.chkUseYourSearch){return;}if((searchInputField.value==lastSearchText)&&lastSearchText&&!isResultOpen()){if(resultElement&&(resultElement.parentNode!=document.body)){document.body.appendChild(resultElement);ensureResultIsDisplayedNicely();}else{showResult();}}};var setFirstIndexOnPage=function(_e6){if(!lastResults||lastResults.length==0){return;}firstIndexOnPage=Math.min(Math.max(0,_e6),lastResults.length-1);refreshResult();};var onDocumentClick=function(e){if(e.target==searchInputField){return;}if(e.target==searchButton){return;}if(resultElement&&isDescendantOrSelf(resultElement,e.target)){return;}closeResult();};var onDocumentKeyup=function(e){if(e.keyCode==27){closeResult();}};addEvent(document,"click",onDocumentClick);addEvent(document,"keyup",onDocumentKeyup);config.macros.yourSearch={label:"yourSearch",prompt:"Gives access to the current/last YourSearch result",funcs:{},tests:{"true":function(){return true;},"false":function(){return false;},"found":function(){return lastResults&&lastResults.length>0;},"previewText":function(){return config.options.chkPreviewText;}}};config.macros.yourSearch.handler=function(_e9,_ea,_eb,_ec,_ed,_ee){if(_eb.length==0){return;}var _ef=_eb[0];var _f0=config.macros.yourSearch.funcs[_ef];if(_f0){_f0(_e9,_ea,_eb,_ec,_ed,_ee);}};config.macros.yourSearch.funcs.itemRange=function(_f1){if(lastResults){var _f2=Math.min(firstIndexOnPage+getItemsPerPage(),lastResults.length);var s="%0 - %1".format([firstIndexOnPage+1,_f2]);createTiddlyText(_f1,s);}};config.macros.yourSearch.funcs.count=function(_f4){if(lastSearchText){createTiddlyText(_f4,lastResults.length.toString());}};config.macros.yourSearch.funcs.query=function(_f5){if(lastResults){createTiddlyText(_f5,lastSearchText);}};config.macros.yourSearch.funcs.version=function(_f6){var t="YourSearch %0.%1.%2".format([version.extensions.YourSearchPlugin.major,version.extensions.YourSearchPlugin.minor,version.extensions.YourSearchPlugin.revision]);var e=createTiddlyElement(_f6,"a");e.setAttribute("href","http://tiddlywiki.abego-software.de/#YourSearchPlugin");e.innerHTML="<font color=\"black\" face=\"Arial, Helvetica, sans-serif\">"+t+"<font>";};config.macros.yourSearch.funcs.copyright=function(_f9){var e=createTiddlyElement(_f9,"a");e.setAttribute("href","http://tiddlywiki.abego-software.de");e.innerHTML="<font color=\"black\" face=\"Arial, Helvetica, sans-serif\">&copy; 2005-2006 <b><font color=\"red\">abego</font></b> Software<font>";};config.macros.yourSearch.funcs.linkButton=function(_fb,_fc,_fd,_fe,_ff,_100){if(_fd<2){return;}var _101=_fd[1];var text=_fd<3?_101:_fd[2];var _103=_fd<4?text:_fd[3];var _104=_fd<5?null:_fd[4];var btn=createTiddlyButton(_fb,text,_103,closeResultAndDisplayTiddler,null,null,_104);btn.setAttribute("tiddlyLink",_101);};config.macros.yourSearch.funcs.closeButton=function(_106,_107,_108,_109,_10a,_10b){var _10c=createTiddlyButton(_106,"close","Close the Search Results (Shortcut: ESC)",closeResult);};config.macros.yourSearch.funcs.openAllButton=function(_10d,_10e,_10f,_110,_111,_112){if(!lastResults){return;}var n=lastResults.length;if(n==0){return;}var _114=n==1?"open tiddler":"open all %0 tiddlers".format([n]);var _115=createTiddlyButton(_10d,_114,"Open all found tiddlers (Shortcut: Alt-O)",openAllFoundTiddlers);_115.setAttribute("accessKey","O");};var onNaviButtonClick=function(e){if(!e){var e=window.event;}var _118=getIntAttribute(this,"page");setFirstIndexOnPage(_118*getItemsPerPage(),0);};config.macros.yourSearch.funcs.naviBar=function(_119,_11a,_11b,_11c,_11d,_11e){if(!lastResults||lastResults.length==0){return;}var _11f=Math.floor(firstIndexOnPage/getItemsPerPage());var _120=Math.floor((lastResults.length-1)/getItemsPerPage());if(_11f>0){var _121=createTiddlyButton(_119,"Previous","Go to previous page (Shortcut: Alt-'<')",onNaviButtonClick,"prev");_121.setAttribute("page",(_11f-1).toString());_121.setAttribute("accessKey","<");}for(var i=-maxPagesInNaviBar;i<maxPagesInNaviBar;i++){var _123=_11f+i;if(_123<0){continue;}if(_123>_120){break;}var _124=(i+_11f+1).toString();var _125=_123==_11f?"currentPage":"otherPage";var _126=createTiddlyButton(_119,_124,"Go to page %0".format([_124]),onNaviButtonClick,_125);_126.setAttribute("page",(_123).toString());}if(_11f<_120){var _127=createTiddlyButton(_119,"Next","Go to next page (Shortcut: Alt-'>')",onNaviButtonClick,"next");_127.setAttribute("page",(_11f+1).toString());_127.setAttribute("accessKey",">");}};config.macros.yourSearch.funcs["if"]=function(_128,_129,_12a,_12b,_12c,_12d){if(_12a.length<2){return;}var _12e=_12a[1];var _12f=(_12e=="not");if(_12f){if(_12a.length<3){return;}_12e=_12a[2];}var test=config.macros.yourSearch.tests[_12e];var _131=false;try{if(test){_131=test(_128,_129,_12a,_12b,_12c,_12d)!=_12f;}else{_131=(!eval(_12e))==_12f;}}catch(ex){}if(!_131){_128.style.display="none";}};var createOptionWithRefresh=function(_132,_133,_134,_135){invokeMacro(_132,"option",_133,_134,_135);var elem=_132.lastChild;var _137=elem.onclick;elem.onclick=function(e){result=_137.apply(this,arguments);refreshResult();return result;};return elem;};config.macros.yourSearch.funcs.chkPreviewText=function(_139,_13a,_13b,_13c,_13d,_13e){var _13f=_13b.slice(1).join(" ");var elem=createOptionWithRefresh(_139,"chkPreviewText",_13c,_13e);elem.setAttribute("accessKey","P");elem.title="Show text preview of found tiddlers (Shortcut: Alt-P)";return elem;};config.macros.foundTiddler={label:"foundTiddler",prompt:"Provides information on the tiddler currently processed on the YourSearch result page",funcs:{}};config.macros.foundTiddler.handler=function(_141,_142,_143,_144,_145,_146){if(!currentTiddler){return;}var name=_143[0];var func=config.macros.foundTiddler.funcs[name];if(func){func(_141,_142,_143,_144,_145,_146);}};var closeResultAndDisplayTiddler=function(e){closeResult();var _14a=this.getAttribute("tiddlyLink");if(_14a){var _14b=this.getAttribute("withHilite");var _14c=highlightHack;if(_14b&&_14b=="true"&&lastQuery){highlightHack=lastQuery.getMarkRegExp();}story.displayTiddler(this,_14a);highlightHack=_14c;}return (false);};var getShortCutNumber=function(){if(!currentTiddler){return -1;}if(indexInPage>=0&&indexInPage<=9){return indexInPage<9?(indexInPage+1):0;}else{return -1;}};config.macros.foundTiddler.funcs.title=function(_14d,_14e,_14f,_150,_151,_152){if(!currentTiddler){return;}var _153=getShortCutNumber();var _154=_153>=0?"Open tiddler (Shortcut: Alt-%0)".format([_153.toString()]):"Open tiddler";var btn=createTiddlyButton(_14d,null,_154,closeResultAndDisplayTiddler,null);btn.setAttribute("tiddlyLink",currentTiddler.title);btn.setAttribute("withHilite","true");createLimitedTextWithMarks(btn,currentTiddler.title,maxCharsInTitle);if(_153>=0){btn.setAttribute("accessKey",_153.toString());}};config.macros.foundTiddler.funcs.tags=function(_156,_157,_158,_159,_15a,_15b){if(!currentTiddler){return;}createLimitedTextWithMarks(_156,currentTiddler.getTags(),maxCharsInTags);};config.macros.foundTiddler.funcs.text=function(_15c,_15d,_15e,_15f,_160,_161){if(!currentTiddler){return;}createLimitedTextWithMarks(_15c,removeTextDecoration(currentTiddler.text),maxCharsInText);};config.macros.foundTiddler.funcs.number=function(_162,_163,_164,_165,_166,_167){var _168=getShortCutNumber();if(_168>=0){var text="%0)".format([_168.toString()]);createTiddlyElement(_162,"span",null,"shortcutNumber",text);}};if(config.options.chkUseYourSearch==undefined){config.options.chkUseYourSearch=true;}if(config.options.chkPreviewText==undefined){config.options.chkPreviewText=true;}if(config.options.chkSearchAsYouType==undefined){config.options.chkSearchAsYouType=true;}if(config.options.txtItemsPerPage==undefined){config.options.txtItemsPerPage=itemsPerPageDefault;}if(config.options.txtItemsPerPageWithPreview==undefined){config.options.txtItemsPerPageWithPreview=itemsPerPageWithPreviewDefault;}config.shadowTiddlers.AdvancedOptions+="\n<<option chkUseYourSearch>> Use 'Your Search' //([[more options|YourSearch Options]])//";config.shadowTiddlers["YourSearch Introduction"]="!About YourSearch\n"+"\n"+"YourSearch gives you a bunch of new features to simplify and speed up your daily searches in TiddlyWiki. It seamlessly integrates into the standard TiddlyWiki search: just start typing into the 'search' field and explore!\n"+"\n"+"''May the '~Alt-F' be with you.''\n"+"\n"+"\n"+"!Features\n"+"* YourSearch searches for tiddlers that match your query ''as you type'' into the 'search' field. It presents a list of the ''\"Top Ten\"'' tiddlers in a ''popup-like window'': the ''[[YourSearch Result]]''. The tiddlers currently displayed in your TiddlyWiki are not affected.\n"+"* Using ''~TiddlerRank technology'' the [[YourSearch Result]] lists the ''most interesting tiddlers first''.\n"+"* Through ''Filtered Search'' and ''Boolean Search'' you can easily refining your search, like excluding words or searching for multiple words. This way less tiddlers are displayed in the [[YourSearch Result]] and you can faster scan the result for the tiddler you are looking for.\n"+"* The [[YourSearch Result]] lists the found tiddlers ''page-wise'', e.g. 10 per page. Use the ''Result Page Navigation Bar'' to navigate between pages if the result does not fit on one page.\n"+"* The [[YourSearch Result]] states the ''total number of found tiddlers''. This way you can quickly decide if you want to browse the result list or if you want to refine your search first to shorten the result list.\n"+"* Beside the ''title of the found tiddlers'' the [[YourSearch Result]] also ''displays tags'' and ''tiddler text previews''. The ''tiddler text preview'' is an extract of the tiddler's content, showing the most interesting parts related to your query (e.g. the texts around the words you are looking for).\n"+"* The words you are looking for are hilited in the titles, tags and text previews of the [[YourSearch Result]].\n"+"* If you are not interested in the tiddler text previews but prefer to get longer lists of tiddlers on one result page you may ''switch of the text preview''.\n"+"* If the [[YourSearch Result]] contains the tiddler you are looking for you can just ''click its title to display'' it in your TiddlyWiki. Alternatively you may also ''open all found tiddlers'' at once. \n"+"* Use [[YourSearch Options]] to customize YourSearch to your needs. E.g. depending on the size of your screen you may change the number of tiddlers displayed in the [[YourSearch Result]]. In the [[YourSearch Options]] and the AdvancedOptions you may also switch off YourSearch in case you temporarily want to use the standard search.\n"+"* For the most frequently actions ''access keys'' are defined so you can perform your search without using the mouse.\n"+"\n";config.shadowTiddlers["YourSearch Help"]="<<tiddler [[YourSearch Introduction]]>>"+"\n"+"!Filtered Search\n"+"Using the Filtered Search you can restrict your search to certain parts of a tiddler, e.g only search the tags or only the titles.\n"+"|!What you want|!What you type|!Example|\n"+"|Search ''titles only''|start word with ''!''|{{{!jonny}}}|\n"+"|Search ''contents only''|start word with ''%''|{{{%football}}}|\n"+"|Search ''tags only''|start word with ''#''|{{{#Plugin}}}|\n"+"\n"+"You may use more than one filter for a word. E.g. {{{!#Plugin}}} finds tiddlers containing \"Plugin\" either in the title or in the tags (but does not look for \"Plugin\" in the content).\n"+"\n"+"!Boolean Search\n"+"The Boolean Search is useful when searching for multiple words.\n"+"|!What you want|!What you type|!Example|\n"+"|''All words'' must exist|List of words|{{{jonny jeremy}}}|\n"+"|''At least one word'' must exist|Separate words by ''or''|{{{jonny or jeremy}}}|\n"+"|A word ''must not exist''|Start word with ''-''|{{{-jonny}}}|\n"+"\n"+"''Note:'' When you specify two words, separated with a space, YourSearch finds all tiddlers that contain both words, but not necessarily next to each other. If you want to find a sequence of word, e.g. '{{{John Brown}}}', you need to put the words into quotes. I.e. you type: {{{\"john brown\"}}}.\n"+"\n"+"!Combine Filtered and Boolean Search\n"+"You are free to combine Filtered and Boolean Search search. E.g. {{{!jonny !jeremy -%football}}} finds tiddlers with both {{{jonny}}} and {{{jeremy}}} in its titles, but no {{{football}}} in content.\n"+"\n"+"!~CaseSensitiveSearch and ~RegExpSearch\n"+"The standard search options ~CaseSensitiveSearch and ~RegExpSearch are fully supported by YourSearch. However when ''~RegExpSearch'' is on Filtered and Boolean Search are disabled.\n"+"\n"+"!Access Keys\n"+"You are encouraged to use the access keys (also called \"shortcut\" keys) for the most frequently used operations. For quick reference these shortcuts are also mentioned in the tooltip for the various buttons etc.\n"+"\n"+"|!Key|!Operation|\n"+"|{{{Alt-F}}}|''The most important keystroke'': It moves the cursor to the search input field so you can directly start typing your query. Pressing {{{Alt-F}}} will also display the previous search result. This way you can quickly display multiple tiddlers using \"Press {{{Alt-F}}}. Select tiddler.\" sequences.|\n"+"|{{{ESC}}}|Closes the [[YourSearch Result]]. When the [[YourSearch Result]] is already closed and the cursor is in the search input field the field's content is cleared so you start a new query.|\n"+"|{{{Alt-1}}}, {{{Alt-2}}},... |Pressing these keys opens the first, second etc. tiddler from the result list.|\n"+"|{{{Alt-O}}}|Opens all found tiddlers.|\n"+"|{{{Alt-P}}}|Toggles the 'Preview Text' mode.|\n"+"|{{{Alt-'<'}}}, {{{Alt-'>'}}}|Displays the previous or next page in the [[YourSearch Result]].|\n"+"|{{{Return}}}|When you have turned off the 'as you type' search mode pressing the {{{Return}}} key actually starts the search (as does pressing the 'search' button).|\n"+"\n";config.shadowTiddlers["YourSearch Options"]="|>|!YourSearch Options|\n"+"|>|<<option chkUseYourSearch>> Use 'Your Search'|\n"+"|!|<<option chkPreviewText>> Show Text Preview|\n"+"|!|<<option chkSearchAsYouType>> 'Search As You Type' Mode (No RETURN required to start search)|\n"+"|!|Number of items on search result page: <<option txtItemsPerPage>>|\n"+"|!|Number of items on search result page with preview text: <<option txtItemsPerPageWithPreview>>|";config.shadowTiddlers["YourSearchStyleSheet"]="/***\n"+"!~YourSearchResult Stylesheet\n"+"***/\n"+"/*{{{*/\n"+".yourSearchResult {\n"+"\tposition: absolute;\n"+"\twidth: 800px;\n"+"\n"+"\tpadding: 0.2em;\n"+"\tlist-style: none;\n"+"\tmargin: 0;\n"+"\n"+"\tbackground: White;\n"+"\tborder: 1px solid DarkGray;\n"+"}\n"+"\n"+"/*}}}*/\n"+"/***\n"+"!!Summary Section\n"+"***/\n"+"/*{{{*/\n"+".yourSearchResult .summary {\n"+"\tborder-bottom-width: thin;\n"+"\tborder-bottom-style: solid;\n"+"\tborder-bottom-color: #999999;\n"+"\tpadding-bottom: 4px;\n"+"}\n"+"\n"+".yourSearchRange, .yourSearchCount, .yourSearchQuery   {\n"+"\tfont-weight: bold;\n"+"}\n"+"\n"+".yourSearchResult .summary .button {\n"+"\tfont-size: 10px;\n"+"\n"+"\tpadding-left: 0.3em;\n"+"\tpadding-right: 0.3em;\n"+"}\n"+"\n"+".yourSearchResult .summary .chkBoxLabel {\n"+"\tfont-size: 10px;\n"+"\n"+"\tpadding-right: 0.3em;\n"+"}\n"+"\n"+"/*}}}*/\n"+"/***\n"+"!!Items Area\n"+"***/\n"+"/*{{{*/\n"+".yourSearchResult .marked {\n"+"\tbackground: none;\n"+"\tfont-weight: bold;\n"+"}\n"+"\n"+".yourSearchItem {\n"+"\tmargin-top: 2px;\n"+"}\n"+"\n"+".yourSearchNumber {\n"+"\tcolor: #808080;\n"+"}\n"+"\n"+"\n"+".yourSearchTags {\n"+"\tcolor: #008000;\n"+"}\n"+"\n"+".yourSearchText {\n"+"\tcolor: #808080;\n"+"\tmargin-bottom: 6px;\n"+"}\n"+"\n"+"/*}}}*/\n"+"/***\n"+"!!Footer\n"+"***/\n"+"/*{{{*/\n"+".yourSearchFooter {\n"+"\tmargin-top: 8px;\n"+"\tborder-top-width: thin;\n"+"\tborder-top-style: solid;\n"+"\tborder-top-color: #999999;\n"+"}\n"+"\n"+".yourSearchFooter a:hover{\n"+"\tbackground: none;\n"+"\tcolor: none;\n"+"}\n"+"/*}}}*/\n"+"/***\n"+"!!Navigation Bar\n"+"***/\n"+"/*{{{*/\n"+".yourSearchNaviBar a {\n"+"\tfont-size: 16px;\n"+"\tmargin-left: 4px;\n"+"\tmargin-right: 4px;\n"+"\tcolor: black;\n"+"\ttext-decoration: underline;\n"+"}\n"+"\n"+".yourSearchNaviBar a:hover {\n"+"\tbackground-color: none;\n"+"}\n"+"\n"+".yourSearchNaviBar .prev {\n"+"\tfont-weight: bold;\n"+"\tcolor: blue;\n"+"}\n"+"\n"+".yourSearchNaviBar .currentPage {\n"+"\tcolor: #FF0000;\n"+"\tfont-weight: bold;\n"+"\ttext-decoration: none;\n"+"}\n"+"\n"+".yourSearchNaviBar .next {\n"+"\tfont-weight: bold;\n"+"\tcolor: blue;\n"+"}\n"+"/*}}}*/\n";config.shadowTiddlers["YourSearchResultTemplate"]="<!--\n"+"{{{\n"+"-->\n"+"<span macro=\"yourSearch if found\">\n"+"<!-- The Summary Header ============================================ -->\n"+"<table class=\"summary\" border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tbody>\n"+"  <tr>\n"+"\t<td align=\"left\">\n"+"\t\tYourSearch Result <span class=\"yourSearchRange\" macro=\"yourSearch itemRange\"></span>\n"+"\t\t&nbsp;of&nbsp;<span class=\"yourSearchCount\" macro=\"yourSearch count\"></span>\n"+"\t\tfor&nbsp;<span class=\"yourSearchQuery\" macro=\"yourSearch query\"></span>\n"+"\t</td>\n"+"\t<td class=\"yourSearchButtons\" align=\"right\">\n"+"\t\t<span macro=\"yourSearch chkPreviewText\"></span><span class=\"chkBoxLabel\">preview text</span>\n"+"\t\t<span macro=\"yourSearch openAllButton\"></span>\n"+"\t\t<span macro=\"yourSearch linkButton 'YourSearch Options' options 'Configure YourSearch'\"></span>\n"+"\t\t<span macro=\"yourSearch linkButton 'YourSearch Help' help 'Get help how to use YourSearch'\"></span>\n"+"\t\t<span macro=\"yourSearch closeButton\"></span>\n"+"\t</td>\n"+"  </tr>\n"+"</tbody></table>\n"+"\n"+"<!-- The List of Found Tiddlers ============================================ -->\n"+"<div id=\"yourSearchResultItems\" itemsPerPage=\"25\" itemsPerPageWithPreview=\"10\"></div>\n"+"\n"+"<!-- The Footer (with the Navigation) ============================================ -->\n"+"<table class=\"yourSearchFooter\" border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tbody>\n"+"  <tr>\n"+"\t<td align=\"left\">\n"+"\t\tResult page: <span class=\"yourSearchNaviBar\" macro=\"yourSearch naviBar\"></span>\n"+"\t</td>\n"+"\t<td align=\"right\"><span macro=\"yourSearch version\"></span>, <span macro=\"yourSearch copyright\"></span>\n"+"\t</td>\n"+"  </tr>\n"+"</tbody></table>\n"+"<!-- end of the 'tiddlers found' case =========================================== -->\n"+"</span>\n"+"\n"+"\n"+"<!-- The \"No tiddlers found\" case =========================================== -->\n"+"<span macro=\"yourSearch if not found\">\n"+"<table class=\"summary\" border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tbody>\n"+"  <tr>\n"+"\t<td align=\"left\">\n"+"\t\tYourSearch Result: No tiddlers found for <span class=\"yourSearchQuery\" macro=\"yourSearch query\"></span>.\n"+"\t</td>\n"+"\t<td class=\"yourSearchButtons\" align=\"right\">\n"+"\t\t<span macro=\"yourSearch linkButton 'YourSearch Options' options 'Configure YourSearch'\"></span>\n"+"\t\t<span macro=\"yourSearch linkButton 'YourSearch Help' help 'Get help how to use YourSearch'\"></span>\n"+"\t\t<span macro=\"yourSearch closeButton\"></span>\n"+"\t</td>\n"+"  </tr>\n"+"</tbody></table>\n"+"</span>\n"+"\n"+"\n"+"<!--\n"+"}}}\n"+"-->\n";config.shadowTiddlers["YourSearchItemTemplate"]="<!--\n"+"{{{\n"+"-->\n"+"<span class='yourSearchNumber' macro='foundTiddler number'></span>\n"+"<span class='yourSearchTitle' macro='foundTiddler title'/></span>&nbsp;-&nbsp;\n"+"<span class='yourSearchTags' macro='foundTiddler tags'/></span>\n"+"<span macro=\"yourSearch if previewText\"><div class='yourSearchText' macro='foundTiddler text'/></div></span>\n"+"<!--\n"+"}}}\n"+"-->";config.shadowTiddlers["YourSearch"]="<<tiddler [[YourSearch Help]]>>";config.shadowTiddlers["YourSearch Result"]="The popup-like window displaying the result of a YourSearch query.";setStylesheet(store.getTiddlerText("YourSearchStyleSheet"),"yourSearch");var origMacros_search_handler=config.macros.search.handler;config.macros.search.handler=myMacroSearchHandler;var ownsOverwrittenFunctions=function(){var _16a=(config.macros.search.handler==myMacroSearchHandler);return _16a;};var checkForOtherHijacker=function(){if(!ownsOverwrittenFunctions()){alert("Message from YourSearchPlugin:\n\n\n"+"Another plugin has disabled the 'Your Search' features.\n\n\n"+"You may disable the other plugin or change the load order of \n"+"the plugins (by changing the names of the tiddlers)\n"+"to enable the 'Your Search' features.");}};setTimeout(checkForOtherHijacker,5000);abego.YourSearch.getStandardRankFunction=function(){return standardRankFunction;};abego.YourSearch.getRankFunction=function(){return abego.YourSearch.getStandardRankFunction();};abego.YourSearch.getCurrentTiddler=function(){return currentTiddler;};}
/***
%/
!Licence and Copyright
Copyright (c) abego Software ~GmbH, 2005-2006 ([[www.abego-software.de|http://www.abego-software.de]])

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of abego Software nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
***/
